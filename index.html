<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruckitRater</title>
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#121212;color:#e0e0e0}
        h1{text-align:center;color:#00ff00;margin-bottom:10px;text-shadow:0 0 10px rgba(0,255,0,.3)}
        .container{max-width:900px;margin:auto;background:#1e1e1e;padding:30px;border-radius:12px;box-shadow:0 0 20px rgba(0,255,0,.2);border:1px solid #00ff00}
        label{display:block;margin-top:20px;font-weight:bold;color:#00ff00}
        input,select{width:100%;padding:12px;margin-top:8px;background:#2d2d2d;border:1px solid #00ff00;border-radius:6px;color:#e0e0e0;font-size:16px}
        input:focus,select:focus{outline:none;box-shadow:0 0 8px rgba(0,255,0,.5)}
        button{margin-top:30px;padding:14px 28px;background:#00ff00;color:#121212;font-weight:bold;font-size:18px;border:none;border-radius:8px;cursor:pointer;box-shadow:0 4px 15px rgba(0,255,0,.4);transition:all .3s;width:100%}
        button:hover{background:#00cc00;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,255,0,.6)}
        #result{margin-top:40px;padding:20px;background:#2d2d2d;border-radius:10px;border:1px solid #00ff00;display:none}
        .note{font-size:.9em;color:#a0a0a0;margin-top:20px}
        table{width:100%;border-collapse:collapse;margin-top:15px}
        th,td{border:1px solid #00ff00;padding:12px;text-align:left}
        th{background:#003300;color:#00ff00}
        #historical{margin-top:40px}
        #status{color:#ffaa00;margin-top:15px;font-weight:bold}
        .fallback-note{color:#ffaa00;font-style:italic;margin-top:10px}
    </style>
</head>
<body>
    <div class="container">
        <h1>TruckitRater</h1>
        <p style="text-align:center;color:#a0a0a0">Latest Dec 2025 national spot all-in rates (DAT/Truckstop trends). Real driving distance via Google Maps (fallback to approx. straight-line if unavailable). Current national diesel ~$3.58/gal.</p>
        
        <label for="origin">Origin (e.g., Chicago, IL):</label>
        <input type="text" id="origin" placeholder="Enter origin">
        
        <label for="destination">Destination (e.g., Dallas, TX):</label>
        <input type="text" id="destination" placeholder="Enter destination">
        
        <label for="equipment">Equipment Type:</label>
        <select id="equipment">
            <option value="van">Dry Van ($2.24/mile all-in)</option>
            <option value="reefer">Reefer ($2.62/mile all-in)</option>
            <option value="flatbed">Flatbed ($2.52/mile all-in)</option>
        </select>
        
        <label for="fuelPrice">Diesel Price ($/gal, current ~$3.58):</label>
        <input type="number" id="fuelPrice" value="3.58" step="0.01" min="2">
        
        <button onclick="calculateRate()">Calculate Rate</button>
        <div id="status"></div>
        
        <div id="result">
            <h2 style="color:#00ff00">Rate Breakdown</h2>
            <p><strong>Lane:</strong> <span id="lane"></span></p>
            <p><strong>Distance:</strong> <span id="dist"></span> miles (<span id="duration"></span>) <span id="fallbackNote" class="fallback-note"></span></p>
            <table>
                <tr><th>Description</th><th>Amount</th></tr>
                <tr><td>All-In Rate (per mile)</td><td>$<span id="avgRPM"></span></td></tr>
                <tr><td>All-In Total</td><td>$<span id="allIn"></span></td></tr>
                <tr><td>Linehaul (per mile)</td><td>$<span id="baseRPM"></span></td></tr>
                <tr><td>Linehaul Total</td><td>$<span id="linehaul"></span></td></tr>
                <tr><td>Fuel Surcharge (6 mpg)</td><td>$<span id="fuel"></span></td></tr>
                <tr><td><strong>Negotiation Target (5-10% below)</strong></td><td><strong>$<span id="targetLow"></span> - $<span id="targetHigh"></span></strong></td></tr>
            </table>
            <p class="note">Aim lower for contracts/volume.</p>
        </div>
        
        <div id="historical">
            <h3 style="color:#00ff00">2025 Trends</h3>
            <table>
                <tr><th>Period</th><th>Van</th><th>Reefer</th><th>Flatbed</th></tr>
                <tr><td>Nov Avg</td><td>$2.09</td><td>$2.54</td><td>$2.47</td></tr>
                <tr><td>Late Dec</td><td><strong>$2.24</strong><td><strong>$2.62</strong><td><strong>$2.52</strong></td></tr>
            </table>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyAcg4vGAUdJW7P2sWsa8Bs7v6DCrnj4SnQ";
        const averages = {van:2.24,reefer:2.62,flatbed:2.52};
        let loaded = false, service;

        const cityCoords = {
            "chicago, il": {lat:41.8781, lng:-87.6298},
            "los angeles, ca": {lat:34.0522, lng:-118.2437},
            "dallas, tx": {lat:32.7767, lng:-96.7970},
            "fort worth, tx": {lat:32.7555, lng:-97.3308},
            "atlanta, ga": {lat:33.7490, lng:-84.3880},
            "houston, tx": {lat:29.7604, lng:-95.3698},
            "new york, ny": {lat:40.7128, lng:-74.0060},
            "denver, co": {lat:39.7392, lng:-104.9903},
            "phoenix, az": {lat:33.4484, lng:-112.0740},
            "seattle, wa": {lat:47.6062, lng:-122.3321},
            "miami, fl": {lat:25.7617, lng:-80.1918},
            "kansas city, mo": {lat:39.0997, lng:-94.5786},
            "memphis, tn": {lat:35.1495, lng:-90.0490},
            "indianapolis, in": {lat:39.7684, lng:-86.1581},
            "charlotte, nc": {lat:35.2271, lng:-80.8431},
            "el paso, tx": {lat:31.7619, lng:-106.4850},
            "salt lake city, ut": {lat:40.7608, lng:-111.8910},
            "laredo, tx": {lat:27.5036, lng:-99.5075},
            "shreveport, la": {lat:32.4877, lng:-93.7626},
            "jacksonville, fl": {lat:30.3322, lng:-81.6557}
        };

        function haversineMiles(lat1, lon1, lat2, lon2) {
            const R = 3958.8;
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }

        function getCoords(cityStr) {
            const key = cityStr.toLowerCase().trim();
            return cityCoords[key] || null;
        }

        function fallbackDistance(origin, destination) {
            const o = getCoords(origin);
            const d = getCoords(destination);
            if (o && d) {
                const miles = haversineMiles(o.lat, o.lng, d.lat, d.lng);
                return {miles, duration: "estimated (straight-line)"};
            }
            return null;
        }

        function loadMaps() {
            if (loaded) return Promise.resolve(true);
            return Promise.race([
                new Promise((res) => {
                    const s = document.createElement('script');
                    s.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=routes&callback=initMaps`;
                    s.async = true; s.defer = true;
                    s.onerror = () => res(false);
                    window.initMaps = () => { loaded=true; service=new google.maps.DistanceMatrixService(); res(true); };
                    document.head.appendChild(s);
                }),
                new Promise((res) => setTimeout(() => res(false), 8000)) // Reduced timeout
            ]);
        }

        async function calculateRate() {
            const o = document.getElementById('origin').value.trim();
            const d = document.getElementById('destination').value.trim();
            const eq = document.getElementById('equipment').value;
            const fuel = parseFloat(document.getElementById('fuelPrice').value) || 3.58;
            const stat = document.getElementById('status');
            const fallbackNote = document.getElementById('fallbackNote');
            stat.textContent = 'Attempting Google Maps...';
            fallbackNote.textContent = '';

            if (!o || !d) return alert('Enter origin & destination');

            let miles, duration = 'N/A', usedFallback = false;
            let googleSuccess = false;

            const mapsOk = await loadMaps();
            if (mapsOk) {
                stat.textContent = 'Fetching real driving distance...';
                googleSuccess = await new Promise((resolve) => {
                    let resolved = false;
                    service.getDistanceMatrix({
                        origins:[o], destinations:[d],
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.IMPERIAL
                    }, (resp, status) => {
                        if (!resolved) {
                            resolved = true;
                            if (status === 'OK' && resp.rows[0].elements[0].status === 'OK') {
                                const el = resp.rows[0].elements[0];
                                miles = Math.round(el.distance.value / 1609.34);
                                duration = el.duration.text;
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        }
                    });
                    setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            resolve(false);
                        }
                    }, 8000);
                });
            }

            if (!googleSuccess) {
                stat.textContent = 'Google failed/unavailable – using fallback distance...';
                const fb = fallbackDistance(o, d);
                if (fb) {
                    miles = fb.miles;
                    duration = fb.duration;
                    usedFallback = true;
                } else {
                    stat.textContent = 'Error: Cities not supported in fallback. Try different cities or check connection/key.';
                    return;
                }
            }

            if (miles < 100) { stat.textContent = 'Distance too short'; return; }

            const rpm = averages[eq];
            const allIn = Math.round(rpm * miles);
            const baseRPM = rpm - (fuel / 6);
            const line = Math.round(baseRPM * miles);
            const fsc = Math.round(miles / 6 * fuel);
            const low = Math.round(allIn * 0.90);
            const high = Math.round(allIn * 0.95);

            document.getElementById('lane').textContent = `${o} → ${d}`;
            document.getElementById('dist').textContent = miles;
            document.getElementById('duration').textContent = duration;
            document.getElementById('avgRPM').textContent = rpm.toFixed(2);
            document.getElementById('allIn').textContent = allIn;
            document.getElementById('baseRPM').textContent = baseRPM.toFixed(2);
            document.getElementById('linehaul').textContent = line;
            document.getElementById('fuel').textContent = fsc;
            document.getElementById('targetLow').textContent = low;
            document.getElementById('targetHigh').textContent = high;

            if (usedFallback) {
                fallbackNote.textContent = '(approx. straight-line – real route ~15-25% longer)';
            }

            document.getElementById('result').style.display = 'block';
            stat.textContent = usedFallback ? 'Success (fallback mode)' : 'Success!';
        }
    </script>
</body>
</html>