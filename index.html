<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruckitRater</title>
    <style>
        body{font-family:Arial,sans-serif;margin:0;padding:20px;background:#121212;color:#e0e0e0}
        h1{text-align:center;color:#00ff00;margin-bottom:10px;text-shadow:0 0 10px rgba(0,255,0,.3)}
        .container{max-width:900px;margin:auto;background:#1e1e1e;padding:30px;border-radius:12px;box-shadow:0 0 20px rgba(0,255,0,.2);border:1px solid #00ff00}
        label{display:block;margin-top:20px;font-weight:bold;color:#00ff00}
        input,select{width:100%;padding:12px;margin-top:8px;background:#2d2d2d;border:1px solid #00ff00;border-radius:6px;color:#e0e0e0;font-size:16px}
        input:focus,select:focus{outline:none;box-shadow:0 0 8px rgba(0,255,0,.5)}
        button{margin-top:30px;padding:14px 28px;background:#00ff00;color:#121212;font-weight:bold;font-size:18px;border:none;border-radius:8px;cursor:pointer;box-shadow:0 4px 15px rgba(0,255,0,.4);transition:all .3s;width:100%}
        button:hover{background:#00cc00;transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,255,0,.6)}
        #result{margin-top:40px;padding:20px;background:#2d2d2d;border-radius:10px;border:1px solid #00ff00;display:none}
        .note{font-size:.9em;color:#a0a0a0;margin-top:20px}
        table{width:100%;border-collapse:collapse;margin-top:15px}
        th,td{border:1px solid #00ff00;padding:12px;text-align:left}
        th{background:#003300;color:#00ff00}
        #historical{margin-top:40px}
        #status{color:#ffaa00;margin-top:15px;font-weight:bold}
        .fallback-note{color:#ffaa00;font-style:italic;margin-top:10px}
        .lane-note{color:#00ffaa;font-style:italic;margin-top:10px}
    </style>
</head>
<body>
    <div class="container">
        <h1>TruckitRater</h1>
        <p style="text-align:center;color:#a0a0a0">Dec 2025 national spot all-in rates (DAT/Truckstop). Lane-specific adjustments for popular routes (higher in tight Midwest/Southeast lanes). Real driving distance via Google Maps (fallback straight-line if unavailable). Diesel ~$3.58/gal.</p>
        
        <label for="origin">Origin (e.g., Chicago, IL):</label>
        <input type="text" id="origin" placeholder="Enter origin">
        
        <label for="destination">Destination (e.g., Dallas, TX):</label>
        <input type="text" id="destination" placeholder="Enter destination">
        
        <label for="equipment">Equipment Type:</label>
        <select id="equipment">
            <option value="van">Dry Van ($2.24/mile national avg)</option>
            <option value="reefer">Reefer ($2.62/mile national avg)</option>
            <option value="flatbed">Flatbed ($2.52/mile national avg)</option>
        </select>
        
        <label for="fuelPrice">Diesel Price ($/gal, current ~$3.58):</label>
        <input type="number" id="fuelPrice" value="3.58" step="0.01" min="2">
        
        <button onclick="calculateRate()">Calculate Rate</button>
        <div id="status"></div>
        
        <div id="result">
            <h2 style="color:#00ff00">Rate Breakdown</h2>
            <p><strong>Lane:</strong> <span id="lane"></span> <span id="laneNote" class="lane-note"></span></p>
            <p><strong>Distance:</strong> <span id="dist"></span> miles (<span id="duration"></span>) <span id="fallbackNote" class="fallback-note"></span></p>
            <table>
                <tr><th>Description</th><th>Amount</th></tr>
                <tr><td>Adjusted All-In Rate (per mile)</td><td>$<span id="adjRPM"></span></td></tr>
                <tr><td>All-In Total</td><td>$<span id="allIn"></span></td></tr>
                <tr><td>Linehaul (per mile)</td><td>$<span id="baseRPM"></span></td></tr>
                <tr><td>Linehaul Total</td><td>$<span id="linehaul"></span></td></tr>
                <tr><td>Fuel Surcharge (6 mpg)</td><td>$<span id="fuel"></span></td></tr>
                <tr><td><strong>Negotiation Target (5-10% below)</strong></td><td><strong>$<span id="targetLow"></span> - $<span id="targetHigh"></span></strong></td></tr>
            </table>
            <p class="note">Aim lower for contracts/volume.</p>
        </div>
        
        <div id="historical">
            <h3 style="color:#00ff00">2025 Trends</h3>
            <table>
                <tr><th>Period</th><th>Van</th><th>Reefer</th><th>Flatbed</th></tr>
                <tr><td>Nov Avg</td><td>$2.09</td><td>$2.54</td><td>$2.47</td></tr>
                <tr><td>Late Dec</td><td><strong>$2.24</strong><td><strong>$2.62</strong><td><strong>$2.52</strong></td></tr>
            </table>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyAcg4vGAUdJW7P2sWsa8Bs7v6DCrnj4SnQ";
        const baseAverages = {van:2.24, reefer:2.62, flatbed:2.52};
        let loaded = false, service;

        // Expanded city database (50+ major markets)
        const cityCoords = {
            "chicago, il": {lat:41.8781, lng:-87.6298},
            "los angeles, ca": {lat:34.0522, lng:-118.2437},
            "dallas, tx": {lat:32.7767, lng:-96.7970},
            "fort worth, tx": {lat:32.7555, lng:-97.3308},
            "atlanta, ga": {lat:33.7490, lng:-84.3880},
            "houston, tx": {lat:29.7604, lng:-95.3698},
            "new york, ny": {lat:40.7128, lng:-74.0060},
            "denver, co": {lat:39.7392, lng:-104.9903},
            "phoenix, az": {lat:33.4484, lng:-112.0740},
            "seattle, wa": {lat:47.6062, lng:-122.3321},
            "miami, fl": {lat:25.7617, lng:-80.1918},
            "kansas city, mo": {lat:39.0997, lng:-94.5786},
            "memphis, tn": {lat:35.1495, lng:-90.0490},
            "indianapolis, in": {lat:39.7684, lng:-86.1581},
            "charlotte, nc": {lat:35.2271, lng:-80.8431},
            "el paso, tx": {lat:31.7619, lng:-106.4850},
            "salt lake city, ut": {lat:40.7608, lng:-111.8910},
            "laredo, tx": {lat:27.5036, lng:-99.5075},
            "shreveport, la": {lat:32.4877, lng:-93.7626},
            "jacksonville, fl": {lat:30.3322, lng:-81.6557},
            "nashville, tn": {lat:36.1627, lng:-86.7816},
            "oklahoma city, ok": {lat:35.4676, lng:-97.5164},
            "san antonio, tx": {lat:29.4241, lng:-98.4936},
            "tampa, fl": {lat:27.9506, lng:-82.4572},
            "orlando, fl": {lat:28.5383, lng:-81.3792},
            "cincinnati, oh": {lat:39.1031, lng:-84.5120},
            "columbus, oh": {lat:39.9612, lng:-82.9988},
            "detroit, mi": {lat:42.3314, lng:-83.0458},
            "minneapolis, mn": {lat:44.9778, lng:-93.2650},
            "st. louis, mo": {lat:38.6270, lng:-90.1994},
            "baltimore, md": {lat:39.2904, lng:-76.6122},
            "philadelphia, pa": {lat:39.9526, lng:-75.1652},
            "boston, ma": {lat:42.3601, lng:-71.0589},
            "portland, or": {lat:45.5152, lng:-122.6784},
            "las vegas, nv": {lat:36.1699, lng:-115.1398},
            "sacramento, ca": {lat:38.5816, lng:-121.4944},
            "san diego, ca": {lat:32.7157, lng:-117.1611},
            "san francisco, ca": {lat:37.7749, lng:-122.4194},
            "oakland, ca": {lat:37.8044, lng:-122.2712},
            "tucson, az": {lat:32.2226, lng:-110.9747},
            "albuquerque, nm": {lat:35.0844, lng:-106.6504},
            "omaha, ne": {lat:41.2565, lng:-95.9345},
            "louisville, ky": {lat:38.2527, lng:-85.7585},
            "greensboro, nc": {lat:36.0726, lng:-79.7920},
            "buffalo, ny": {lat:42.8864, lng:-78.8784},
            "cleveland, oh": {lat:41.4993, lng:-81.6944},
            "milwaukee, wi": {lat:43.0389, lng:-87.9065},
            "riverside, ca": {lat:33.9533, lng:-117.3962},
            "stockton, ca": {lat:37.9577, lng:-121.2908},
            "fresno, ca": {lat:36.7468, lng:-119.7726}
        };

        // Lane-specific adjustments (multipliers) based on Dec 2025 trends: higher in Midwest/Southeast, lower in West/Northeast
        const laneAdjustments = {
            van: {
                midwest: 1.08, // e.g., +$0.17 over national ~$2.41
                southeast: 1.03,
                default: 1.00
            },
            reefer: {
                midwest: 1.13, // highest ~$2.97
                default: 1.00
            },
            flatbed: {
                southeast: 1.05, // ~$2.64
                midwest: 1.05,
                default: 1.00
            }
        };

        // Simple region classification by city
        const regions = {
            midwest: ["chicago, il","indianapolis, in","detroit, mi","cleveland, oh","columbus, oh","cincinnati, oh","milwaukee, wi","minneapolis, mn","st. louis, mo","kansas city, mo","omaha, ne"],
            southeast: ["atlanta, ga","charlotte, nc","greensboro, nc","jacksonville, fl","tampa, fl","orlando, fl","miami, fl","memphis, tn","nashville, tn"],
            west: ["los angeles, ca","san francisco, ca","oakland, ca","seattle, wa","portland, or","sacramento, ca","san diego, ca","phoenix, az","las vegas, nv","denver, co","salt lake city, ut"]
        };

        function getRegion(cityKey) {
            if (regions.midwest.includes(cityKey)) return 'midwest';
            if (regions.southeast.includes(cityKey)) return 'southeast';
            if (regions.west.includes(cityKey)) return 'west';
            return 'default';
        }

        function getAdjustedRPM(eq, originKey, destKey) {
            let rpm = baseAverages[eq];
            const adj = laneAdjustments[eq] || {default:1.00};
            const originRegion = getRegion(originKey);
            const destRegion = getRegion(destKey);

            // Apply highest adjustment from origin or dest region
            let multiplier = 1.00;
            if (adj[originRegion]) multiplier = Math.max(multiplier, adj[originRegion]);
            if (adj[destRegion]) multiplier = Math.max(multiplier, adj[destRegion]);
            if (adj.default) multiplier = Math.max(multiplier, adj.default);

            const adjusted = rpm * multiplier;
            return {adjusted, note: multiplier > 1.00 ? `(adjusted +${Math.round((multiplier-1)*100)}% for tight lane)` : ''};
        }

        // Rest of the functions (haversine, fallback, loadMaps, calculateRate) remain the same...
        function haversineMiles(lat1, lon1, lat2, lon2) {
            const R = 3958.8;
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }

        function getCoords(cityStr) {
            const key = cityStr.toLowerCase().trim();
            return cityCoords[key] || null;
        }

        function fallbackDistance(origin, destination) {
            const o = getCoords(origin);
            const d = getCoords(destination);
            if (o && d) {
                const miles = haversineMiles(o.lat, o.lng, d.lat, d.lng);
                return {miles, duration: "estimated (straight-line)"};
            }
            return null;
        }

        function loadMaps() {
            if (loaded) return Promise.resolve(true);
            return Promise.race([
                new Promise((res) => {
                    const s = document.createElement('script');
                    s.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=routes&callback=initMaps`;
                    s.async = true; s.defer = true;
                    s.onerror = () => res(false);
                    window.initMaps = () => { loaded=true; service=new google.maps.DistanceMatrixService(); res(true); };
                    document.head.appendChild(s);
                }),
                new Promise((res) => setTimeout(() => res(false), 8000))
            ]);
        }

        async function calculateRate() {
            const oInput = document.getElementById('origin').value.trim();
            const dInput = document.getElementById('destination').value.trim();
            const eq = document.getElementById('equipment').value;
            const fuel = parseFloat(document.getElementById('fuelPrice').value) || 3.58;
            const stat = document.getElementById('status');
            const fallbackNote = document.getElementById('fallbackNote');
            const laneNote = document.getElementById('laneNote');
            stat.textContent = 'Attempting Google Maps...';
            fallbackNote.textContent = '';
            laneNote.textContent = '';

            if (!oInput || !dInput) return alert('Enter origin & destination');

            const oKey = oInput.toLowerCase().trim();
            const dKey = dInput.toLowerCase().trim();

            let miles, duration = 'N/A', usedFallback = false;
            let googleSuccess = false;

            const mapsOk = await loadMaps();
            if (mapsOk) {
                stat.textContent = 'Fetching real driving distance...';
                googleSuccess = await new Promise((resolve) => {
                    let resolved = false;
                    service.getDistanceMatrix({
                        origins:[oInput], destinations:[dInput],
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.IMPERIAL
                    }, (resp, status) => {
                        if (!resolved) {
                            resolved = true;
                            if (status === 'OK' && resp.rows[0].elements[0].status === 'OK') {
                                const el = resp.rows[0].elements[0];
                                miles = Math.round(el.distance.value / 1609.34);
                                duration = el.duration.text;
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        }
                    });
                    setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            resolve(false);
                        }
                    }, 8000);
                });
            }

            if (!googleSuccess) {
                stat.textContent = 'Google failed – using fallback distance...';
                const fb = fallbackDistance(oInput, dInput);
                if (fb) {
                    miles = fb.miles;
                    duration = fb.duration;
                    usedFallback = true;
                } else {
                    stat.textContent = 'Error: Cities not in database.';
                    return;
                }
            }

            if (miles < 100) { stat.textContent = 'Distance too short'; return; }

            const {adjusted: adjRPM, note: laneAdjNote} = getAdjustedRPM(eq, oKey, dKey);

            const allIn = Math.round(adjRPM * miles);
            const baseRPM = adjRPM - (fuel / 6);
            const line = Math.round(baseRPM * miles);
            const fsc = Math.round(miles / 6 * fuel);
            const low = Math.round(allIn * 0.90);
            const high = Math.round(allIn * 0.95);

            document.getElementById('lane').textContent = `${oInput} → ${dInput}`;
            document.getElementById('dist').textContent = miles;
            document.getElementById('duration').textContent = duration;
            document.getElementById('adjRPM').textContent = adjRPM.toFixed(2);
            document.getElementById('allIn').textContent = allIn;
            document.getElementById('baseRPM').textContent = baseRPM.toFixed(2);
            document.getElementById('linehaul').textContent = line;
            document.getElementById('fuel').textContent = fsc;
            document.getElementById('targetLow').textContent = low;
            document.getElementById('targetHigh').textContent = high;

            if (laneAdjNote) laneNote.textContent = laneAdjNote;
            if (usedFallback) fallbackNote.textContent = '(approx. straight-line – real ~15-25% longer)';

            document.getElementById('result').style.display = 'block';
            stat.textContent = usedFallback ? 'Success (fallback)' : 'Success!';
        }
    </script>
</body>
</html>
